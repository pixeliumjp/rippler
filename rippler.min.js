var m=class E{static DEFAULTS={imageUrl:null,resolution:256,dropRadius:20,perturbance:.03,interactive:!0,crossOrigin:""};constructor(e,t={}){this.element=e,this.options={...E.DEFAULTS,...t},this.interactive=this.options.interactive,this.resolution=this.options.resolution,this.textureDelta=new Float32Array([1/this.resolution,1/this.resolution]),this.perturbance=this.options.perturbance,this.dropRadius=this.options.dropRadius,this.crossOrigin=this.options.crossOrigin,this.imageUrl=this.options.imageUrl,this.canvas=null,this.gl=null,this.config=null,this.visible=!0,this.running=!0,this.destroyed=!1,this.textures=[],this.framebuffers=[],this.bufferWriteIndex=0,this.bufferReadIndex=1,this.dropProgram=null,this.updateProgram=null,this.renderProgram=null,this.backgroundTexture=null,this.backgroundWidth=0,this.backgroundHeight=0,this.imageSource=null,this._init()}_init(){if(this.config=this._loadConfig(),!this.config)throw new Error("Your browser does not support WebGL or the required extensions");this._createCanvas(),this._initGL(),this._boundUpdateSize=this.updateSize.bind(this),window.addEventListener("resize",this._boundUpdateSize),this._setupPointerEvents(),this.loadImage(),this._animate()}_loadConfig(){let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return null;let r={},s=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear"];for(let d of s){let u=t.getExtension(d);u&&(r[d]=u)}if(!r.OES_texture_float)return null;let i=[],n=(d,u,f)=>{let c="OES_texture_"+d,l=c+"_linear",g=l in r,p=[c];return g&&p.push(l),{type:u,arrayType:f,linearSupport:g,extensions:p}};i.push(n("float",t.FLOAT,Float32Array)),r.OES_texture_half_float&&i.push(n("half_float",r.OES_texture_half_float.HALF_FLOAT_OES,null));let o=t.createTexture(),h=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,h),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);let a=null;for(let d of i)if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,32,32,0,t.RGBA,d.type,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,o,0),t.checkFramebufferStatus(t.FRAMEBUFFER)===t.FRAMEBUFFER_COMPLETE){a=d;break}return a}_createCanvas(){this.canvas=document.createElement("canvas"),this.canvas.width=this.element.clientWidth,this.canvas.height=this.element.clientHeight,Object.assign(this.canvas.style,{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",zIndex:"-1"}),this.element.classList.add("rippler-container"),this.element.style.position="relative",this.element.appendChild(this.canvas)}_initGL(){let e=this.gl=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");for(let s of this.config.extensions)e.getExtension(s);let t=this.config.arrayType,r=t?new t(this.resolution*this.resolution*4):null;for(let s=0;s<2;s++){let i=e.createTexture(),n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n),e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.config.linearSupport?e.LINEAR:e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.config.linearSupport?e.LINEAR:e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.resolution,this.resolution,0,e.RGBA,this.config.type,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),this.textures.push(i),this.framebuffers.push(n)}this.quad=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quad),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),e.STATIC_DRAW),this._initShaders(),this._initTexture(),this._setTransparentTexture(),e.clearColor(0,0,0,0),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}_initShaders(){let e=this.gl,t=`
attribute vec2 vertex;
varying vec2 coord;
void main() {
coord = vertex * 0.5 + 0.5;
gl_Position = vec4(vertex, 0.0, 1.0);
}
`;this.dropProgram=this._createProgram(t,`
precision highp float;
const float PI = 3.141592653589793;
uniform sampler2D texture;
uniform vec2 center;
uniform float radius;
uniform float strength;
varying vec2 coord;
void main() {
vec4 info = texture2D(texture, coord);
float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - coord) / radius);
drop = 0.5 - cos(drop * PI) * 0.5;
info.r += drop * strength;
gl_FragColor = info;
}
`),this.updateProgram=this._createProgram(t,`
precision highp float;
uniform sampler2D texture;
uniform vec2 delta;
varying vec2 coord;
void main() {
vec4 info = texture2D(texture, coord);
vec2 dx = vec2(delta.x, 0.0);
vec2 dy = vec2(0.0, delta.y);
float average = (
texture2D(texture, coord - dx).r +
texture2D(texture, coord - dy).r +
texture2D(texture, coord + dx).r +
texture2D(texture, coord + dy).r
) * 0.25;
info.g += (average - info.r) * 2.0;
info.g *= 0.995;
info.r += info.g;
gl_FragColor = info;
}
`),e.uniform2fv(this.updateProgram.locations.delta,this.textureDelta),this.renderProgram=this._createProgram(`
precision highp float;
attribute vec2 vertex;
uniform vec2 topLeft;
uniform vec2 bottomRight;
uniform vec2 containerRatio;
varying vec2 ripplesCoord;
varying vec2 backgroundCoord;
void main() {
backgroundCoord = mix(topLeft, bottomRight, vertex * 0.5 + 0.5);
backgroundCoord.y = 1.0 - backgroundCoord.y;
ripplesCoord = vec2(vertex.x, -vertex.y) * containerRatio * 0.5 + 0.5;
gl_Position = vec4(vertex.x, -vertex.y, 0.0, 1.0);
}
`,`
precision highp float;
uniform sampler2D samplerBackground;
uniform sampler2D samplerRipples;
uniform vec2 delta;
uniform float perturbance;
varying vec2 ripplesCoord;
varying vec2 backgroundCoord;
void main() {
float height = texture2D(samplerRipples, ripplesCoord).r;
float heightX = texture2D(samplerRipples, vec2(ripplesCoord.x + delta.x, ripplesCoord.y)).r;
float heightY = texture2D(samplerRipples, vec2(ripplesCoord.x, ripplesCoord.y + delta.y)).r;
vec3 dx = vec3(delta.x, heightX - height, 0.0);
vec3 dy = vec3(0.0, heightY - height, delta.y);
vec2 offset = -normalize(cross(dy, dx)).xz;
float specular = pow(max(0.0, dot(offset, normalize(vec2(-0.6, 1.0)))), 4.0);
gl_FragColor = texture2D(samplerBackground, backgroundCoord + offset * perturbance) + specular;
}
`),e.uniform2fv(this.renderProgram.locations.delta,this.textureDelta)}_createProgram(e,t){let r=this.gl,s=(a,d)=>{let u=r.createShader(a);if(r.shaderSource(u,d),r.compileShader(u),!r.getShaderParameter(u,r.COMPILE_STATUS))throw new Error("Compile error: "+r.getShaderInfoLog(u));return u},i={id:r.createProgram(),uniforms:{},locations:{}};if(r.attachShader(i.id,s(r.VERTEX_SHADER,e)),r.attachShader(i.id,s(r.FRAGMENT_SHADER,t)),r.linkProgram(i.id),!r.getProgramParameter(i.id,r.LINK_STATUS))throw new Error("Link error: "+r.getProgramInfoLog(i.id));r.useProgram(i.id),r.enableVertexAttribArray(0);let n=/uniform (\w+) (\w+)/g,o=e+t,h;for(;(h=n.exec(o))!==null;){let a=h[2];i.locations[a]=r.getUniformLocation(i.id,a)}return i}_initTexture(){let e=this.gl;this.backgroundTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.backgroundTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)}_setTransparentTexture(){let e=this.gl,t=this._createImageData(32,32);e.bindTexture(e.TEXTURE_2D,this.backgroundTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}_createImageData(e,t){try{return new ImageData(e,t)}catch{return document.createElement("canvas").getContext("2d").createImageData(e,t)}}_setupPointerEvents(){let e=(t,r=!1)=>{if(this.visible&&this.running&&this.interactive){let s=this.element.getBoundingClientRect(),i=t.clientX-s.left,n=t.clientY-s.top;this.drop(i,n,this.dropRadius*(r?1.5:1),r?.14:.01)}};this.element.addEventListener("mousemove",t=>e(t)),this.element.addEventListener("mousedown",t=>e(t,!0)),this.element.addEventListener("touchstart",t=>{for(let r of t.changedTouches)e(r)}),this.element.addEventListener("touchmove",t=>{for(let r of t.changedTouches)e(r)})}_animate(){this.destroyed||(this.step(),requestAnimationFrame(()=>this._animate()))}loadImage(){let e=this.gl,t=window.getComputedStyle(this.element).backgroundImage,r=this.imageUrl||this._extractUrl(t);if(r===this.imageSource)return;if(this.imageSource=r,!this.imageSource){this._setTransparentTexture();return}let s=new Image;s.onload=()=>{let i=o=>(o&o-1)===0,n=i(s.width)&&i(s.height)?e.REPEAT:e.CLAMP_TO_EDGE;e.bindTexture(e.TEXTURE_2D,this.backgroundTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),this.backgroundWidth=s.width,this.backgroundHeight=s.height,this._hideCssBackground()},s.onerror=()=>{this._setTransparentTexture()},s.crossOrigin=this._isDataUri(this.imageSource)?null:this.crossOrigin,s.src=this.imageSource}step(){this.visible&&(this._computeTextureBoundaries(),this.running&&this.update(),this.render())}render(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.canvas.width,this.canvas.height),e.enable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.useProgram(this.renderProgram.id),this._bindTexture(this.backgroundTexture,0),this._bindTexture(this.textures[0],1),e.uniform1f(this.renderProgram.locations.perturbance,this.perturbance),e.uniform2fv(this.renderProgram.locations.topLeft,this.renderProgram.uniforms.topLeft),e.uniform2fv(this.renderProgram.locations.bottomRight,this.renderProgram.uniforms.bottomRight),e.uniform2fv(this.renderProgram.locations.containerRatio,this.renderProgram.uniforms.containerRatio),e.uniform1i(this.renderProgram.locations.samplerBackground,0),e.uniform1i(this.renderProgram.locations.samplerRipples,1),this._drawQuad(),e.disable(e.BLEND)}update(){let e=this.gl;e.viewport(0,0,this.resolution,this.resolution),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffers[this.bufferWriteIndex]),this._bindTexture(this.textures[this.bufferReadIndex]),e.useProgram(this.updateProgram.id),this._drawQuad(),this._swapBufferIndices()}drop(e,t,r,s){let i=this.gl,n=this.element.clientWidth,o=this.element.clientHeight,h=Math.max(n,o);r=r/h;let a=new Float32Array([(2*e-n)/h,(o-2*t)/h]);i.viewport(0,0,this.resolution,this.resolution),i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffers[this.bufferWriteIndex]),this._bindTexture(this.textures[this.bufferReadIndex]),i.useProgram(this.dropProgram.id),i.uniform2fv(this.dropProgram.locations.center,a),i.uniform1f(this.dropProgram.locations.radius,r),i.uniform1f(this.dropProgram.locations.strength,s),this._drawQuad(),this._swapBufferIndices()}updateSize(){let e=this.element.clientWidth,t=this.element.clientHeight;(e!==this.canvas.width||t!==this.canvas.height)&&(this.canvas.width=e,this.canvas.height=t)}destroy(){this.destroyed=!0,window.removeEventListener("resize",this._boundUpdateSize),this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this._restoreCssBackground(),this.element.classList.remove("rippler-container"),this.gl=null}show(){this.visible=!0,this.canvas.style.display="block",this._hideCssBackground()}hide(){this.visible=!1,this.canvas.style.display="none",this._restoreCssBackground()}pause(){this.running=!1}play(){this.running=!0}set(e,t){switch(e){case"dropRadius":case"perturbance":case"interactive":case"crossOrigin":this[e]=t;break;case"imageUrl":this.imageUrl=t,this.loadImage();break}}_bindTexture(e,t=0){let r=this.gl;r.activeTexture(r.TEXTURE0+t),r.bindTexture(r.TEXTURE_2D,e)}_drawQuad(){let e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,this.quad),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLE_FAN,0,4)}_swapBufferIndices(){this.bufferWriteIndex=1-this.bufferWriteIndex,this.bufferReadIndex=1-this.bufferReadIndex}_extractUrl(e){let t=/url\(["']?([^"']*)["']?\)/.exec(e);return t?t[1]:null}_isDataUri(e){return/^data:/.test(e)}_hideCssBackground(){this.originalBackgroundImage=this.element.style.backgroundImage,this.element.style.backgroundImage="none"}_restoreCssBackground(){this.originalBackgroundImage!==void 0&&(this.element.style.backgroundImage=this.originalBackgroundImage)}_computeTextureBoundaries(){let e=window.getComputedStyle(this.element),t=e.backgroundSize,r=e.backgroundAttachment,s=this._translateBackgroundPosition(e.backgroundPosition),i;if(r==="fixed")i={left:window.pageXOffset,top:window.pageYOffset,width:window.innerWidth,height:window.innerHeight};else{let c=this.element.getBoundingClientRect();i={left:c.left+window.pageXOffset,top:c.top+window.pageYOffset,width:this.element.clientWidth,height:this.element.clientHeight}}let n,o;if(t==="cover"){let c=Math.max(i.width/this.backgroundWidth,i.height/this.backgroundHeight);n=this.backgroundWidth*c,o=this.backgroundHeight*c}else if(t==="contain"){let c=Math.min(i.width/this.backgroundWidth,i.height/this.backgroundHeight);n=this.backgroundWidth*c,o=this.backgroundHeight*c}else{let c=t.split(" "),l=c[0]||"",g=c[1]||l;this._isPercentage(l)?n=i.width*parseFloat(l)/100:l!=="auto"&&(n=parseFloat(l)),this._isPercentage(g)?o=i.height*parseFloat(g)/100:g!=="auto"&&(o=parseFloat(g)),l==="auto"&&g==="auto"?(n=this.backgroundWidth,o=this.backgroundHeight):(l==="auto"&&(n=this.backgroundWidth*(o/this.backgroundHeight)),g==="auto"&&(o=this.backgroundHeight*(n/this.backgroundWidth)))}let h=s[0],a=s[1];this._isPercentage(h)?h=i.left+(i.width-n)*parseFloat(h)/100:h=i.left+parseFloat(h),this._isPercentage(a)?a=i.top+(i.height-o)*parseFloat(a)/100:a=i.top+parseFloat(a);let d=this.element.getBoundingClientRect(),u={left:d.left+window.pageXOffset,top:d.top+window.pageYOffset};this.renderProgram.uniforms.topLeft=new Float32Array([(u.left-h)/n,(u.top-a)/o]),this.renderProgram.uniforms.bottomRight=new Float32Array([this.renderProgram.uniforms.topLeft[0]+this.element.clientWidth/n,this.renderProgram.uniforms.topLeft[1]+this.element.clientHeight/o]);let f=Math.max(this.canvas.width,this.canvas.height);this.renderProgram.uniforms.containerRatio=new Float32Array([this.canvas.width/f,this.canvas.height/f])}_isPercentage(e){return e&&e[e.length-1]==="%"}_translateBackgroundPosition(e){let t=e.split(" ");if(t.length===1)switch(e){case"center":return["50%","50%"];case"top":return["50%","0"];case"bottom":return["50%","100%"];case"left":return["0","50%"];case"right":return["100%","50%"];default:return[e,"50%"]}return t.map(r=>{switch(r){case"center":return"50%";case"top":case"left":return"0";case"right":case"bottom":return"100%";default:return r}})}},_=m;export{_ as default};
